<!DOCTYPE html>
<html>
 <head>
    <meta charset="utf-8">
    <style type="text/css">

    	*{
    		box-sizing:border-box;
    		-ms-box-sizing:border-box;
    		-moz-box-sizing:border-box;
    		-webkit-box-sizing:border-box;
    		padding: 0;
    		margin: 0;
    	}
    	body{
    		background: #eeeeef;

    	}
    	#container_d3{
    		transform-origin:50% 50%;
    		-ms-transform-origin:50% 50%;
    		-moz-transform-origin:50% 50%;
    		-webkit-transform-origin:50% 50%;

    		transition:all 1s ease;
    		-ms-transition:all 1s ease;
    		-moz-transition:all 1s ease;
    		-webkit-transition:all 1s ease;
    	}
    	.secteur{
    		fill:#f1f1f1;
    		stroke:#ddd;
    		stroke-width:1px;
    	}
    	.secteurHover{
    		fill:#3C98FF;
    		stroke:#3C98FF;
    		cursor: pointer;
    	}
    	.secteurHighlight{
    		fill:#fff;
    	}

    	.svg_defs{
    		display: none;
    	}
    	#svg_d3{
    		z-index: 100;
    	}
       	#infosSecteurs{
    		position: absolute;
    		z-index: 50;
    		width:360px;
    		height: 100px;
    		top:50%;
    		left:50%;
    		margin-left: -180px;
    		margin-top: -50px;
    		text-align: center;
    		padding-top: 20px
    	}
    	#infosSecteurs input[placeholder]{
    		min-width: 250px;
    		max-width: 360px;
    		height:40px;
    		border:#ddd;
    		background: #fafafa;
    		text-align: center;
    	}

    </style>
  </head>
  <body>
  	<div id="container_d3">
  		<div id="svg_d3"></div>
	  	<div id="infosSecteurs">
	  		<input type="text" placeholder="Nom du secteur">
	  		<p>Pour faire apparaitre le nom d'un secteur, passez votre souris sur l'icone correspondante</p>
	  	</div>
  	</div>
  	<svg class="svg_defs">
  		<defs>

  		</defs>
  	</svg>
  	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script type="text/javascript" src="d3.v3.min.js"></script>
    <script type="text/javascript">
    	// 39 secteurs à afficher en rond :)
		// largely based on http://bl.ocks.org/4063550

		// basic settings
		var w = window.innerWidth,
		    h = window.innerHeight;

		var outer_circle_radius = 550/2;
		var inner_circle_radius = 450/2;

		var selectPlaceholder = document.querySelectorAll("#infosSecteurs>input[placeholder]")[0];
		var inputRecherche = document.querySelectorAll('#infosSecteurs>input')[0];
		var ph_current_value = "Nom du secteur";
		selectPlaceholder.value = ph_current_value;

		//Petit UX lors du premier click sur le champ de recherche
		inputRecherche.addEventListener("click",function(){
			if(selectPlaceholder.value == "Nom du secteur"){
				selectPlaceholder.value = "";}
		},false);

		// size scale for data
		/*var radiusScale = d3.scale.sqrt()
		    .domain([0, d3.max(data)])
		    .range([0, maxRadius]);*/
		var radiusScale = function(){return 50/2;};

		// determine the appropriate radius for the circle
		/*
		var roughCircumference = d3.sum(data.map(radiusScale)) * 2 + padding * (data.length - 1),
		    radius = roughCircumference / (Math.PI * 2);*/

		function getRadius (isInner) {
			if(isInner)
				return inner_circle_radius;
			else
				return outer_circle_radius;
		}

		// make 2 radial tree layout
		var tree1 = d3.layout.tree()
		    .size([360, getRadius(false)])
		    .separation(function(a, b) {
		        return radiusScale(a.size) + radiusScale(b.size);
		    });

		var tree2 = d3.layout.tree()
		    .size([360, getRadius(true)])
		    .separation(function(a, b) {
		        return radiusScale(a.size) + radiusScale(b.size);
		    });

		// make the svg
		var svg_circle1 = d3.select("#svg_d3").append("svg")
		    .attr("width", w)
		    .attr("height", h)
		    .attr("id","svg_circles")
		  .append("g")
		    .attr("transform", "translate(" + (w / 2) + "," + (h / 2) + ")") //center the circle

		var svg_circle2 = d3.select("#svg_circles")
			.append("g")
			.attr("transform", "translate(" + (w / 2) + "," + (h / 2) + ") rotate("+360/39+")") //center the circle



		d3.json('secteurs.json', function(req, secjson) {

			// some made-up data
			var dataOri = secjson.features;
			//Couper le tableau en 2 pour les 2 cercles
			var data = dataOri.slice(0,dataOri.length/2);
			var data2 = dataOri.slice(dataOri.length/2,dataOri.length);

			// tree-ify our fake data
			var dataTree = {
			    children: data.map(function(d) { return d; })
			};
			var dataTree2 = {
			    children: data2.map(function(d) { return d; })
			};

			// apply the layout to the data
			var secteurs_out = tree1.nodes(dataTree);
			var secteurs_in = tree2.nodes(dataTree2);

			// create dom elements for the node
			var secteur_circle1 = svg_circle1.selectAll(".secteur")
			      .data(secteurs_out.slice(1)) // cut out the root node, we don't need it
				    .enter()
				    	.append("g")
				      	.attr("class", "secteur")
				      	.attr("secteur_id", function(d){ return d.propreties.ID_SECTEUR; })
				      	.attr("secteur_nom", function(d){ return d.propreties.NOM_SECTEUR; })
				      	.attr("transform", function(d) {
				          return "rotate(" + (d.x - 90) + ") translate(" + d.y + ")";
				      	})

			var secteur_circle2 = svg_circle2.selectAll(".secteur")
			      .data(secteurs_in.slice(1)) // cut out the root node, we don't need it
				    .enter()
				    	.append("g")
				      	.attr("class", "secteur")
				      	.attr("secteur_id", function(d){ return d.propreties.ID_SECTEUR; })
				      	.attr("secteur_nom", function(d){ return d.propreties.NOM_SECTEUR; })
				      	.attr("transform", function(d) {
				          return "rotate(" + (d.x - 90) + ") translate(" + d.y + ")";
				      	})
			//Cercles exterieur
			secteur_circle1.append("circle")
			    .attr("r", "0")
			    .on("mouseover",afficherNomSecteur,false)
			    .on("mouseout",unHoverSecteur,false)
			    .on("click",selectionSecteur,false)
			    .attr("fill-opacity","0.0")
			  	.attr("stroke-opacity","0.0")

		    	.transition()
			  		.delay(function(d,i){ return i*40; })
			  		.duration(500)
			  		.attr("fill-opacity","1.0")
			  		.attr("stroke-opacity","1.0")
			  		.attr("r", function(d) { return radiusScale(d.size); });
			//Cercles interieur
			secteur_circle2.append("circle")
			    .attr("r", "0")
			    .on("mouseover",afficherNomSecteur,false)
			    .on("mouseout",unHoverSecteur,false)
			    .on("click",selectionSecteur,false)
			    .attr("fill-opacity","0.0")
			  	.attr("stroke-opacity","0.0")

			    .transition()
			  		.delay(function(d,i){ return 800+i*40; })
			  		.duration(500)
			  		.attr("fill-opacity","1.0")
			  		.attr("stroke-opacity","1.0")
			  		.attr("r", function(d) { return radiusScale(d.size); });

			function afficherNomSecteur(d){
				ph_current_value = selectPlaceholder.value;

				d3.select(this).classed("secteurHover",true);
				selectPlaceholder.value = this.parentNode.getAttribute('secteur_nom');
			}
			function unHoverSecteur(){
				d3.select(this).classed("secteurHover",false);

				selectPlaceholder.value = ph_current_value;
			}

		});

		//La recherche Live, déclaré après l'init du d3
		/*
		inputRecherche.onchange = function() {
			if ( this.value == this.getAttribute('value') ) {
				this.value='';
			}
			alert("COUCOU");
			console.log("CONNARD");

		}
		*/
		var tousLesSecteurs = document.getElementsByClassName('secteur');

		inputRecherche.onkeyup = function(){
			//console.log(inputRecherche.value.toString());
			if(inputRecherche.value.toString() != "")
			{
				for(var i=0;i<tousLesSecteurs.length;i++)
				{
					if( compareString( noAccentNoCase( tousLesSecteurs[i].getAttribute('secteur_nom') ), noAccentNoCase( inputRecherche.value ) ) ){
						tousLesSecteurs[i].classList.add("secteurHighlight");
					}else{
						tousLesSecteurs[i].classList.remove("secteurHighlight");
					}
				}
			}else{
				for(var i=0;i<tousLesSecteurs.length;i++)
					tousLesSecteurs[i].classList.remove("secteurHighlight");
			}
		};

		function compareString( string, searchVal ){
			var regEx = new RegExp(searchVal, "g");
			var result = regEx.test(string);
			return result;
		}

		function noAccentNoCase(string){
			var stringLower = string.toLowerCase();
			var stringReturn = "";
			for(var i=0;i<stringLower.length;i++)
			{
				switch(stringLower[i]){
					//e
					case "é":
					case "è":
					case "ë":
					case "ê":
						stringReturn += "e";
					break;
					//a
					case "à":
					case "ä":
					case "â":
						stringReturn += "a";
					break;
					//c
					case "ç":
						stringReturn += "c";
					break;
					//o
					case "ö":
					case "ô":
						stringReturn += "o";
					break;
					//i
					case "ï":
					case "î":
						tringReturn += "i";
					break;
					//u
					case "û":
					case "ü":
						stringReturn += "u";
					break;

					default:
						stringReturn += stringLower[i];
					break;
				}
			}
			return stringReturn;

		}

		function selectionSecteur(){
			console.log("Nom du secteur : "+this.parentNode.getAttribute('secteur_nom')+"\n Id du secteur : "+this.parentNode.getAttribute('secteur_id'));
		}

    </script>
  </body>
</html>